#前端监控方案
##背景：
H5相对于PC应用来说，运行环境更为复杂多样，除了浏览器内核差异，手机系统、系统版本、webview的差异都可能造成页面显示差异甚至引起bug。
而测试环境一般并不能穷尽所有机型系统，甚至于top50的手机及系统都不能覆盖到，通常也不值得为了发现可能存在的兼容性bug测试太多机型。
因此，线上的异常监控主要是服务于较少出现、较难复现的bug的捕捉和追踪；至于避免大量用户出现bug，除了代码严谨、测试环节不疏漏，灰度机制也是重要保障，不在此处讨论的监控范畴。

当H5页面跑在自家开发的客户端上时，尚且可以打开测试环境开关实际操作调试bug，若接入第三方平台，只通过服务端接口日志有时难以排查问题，用户异常操作、第三方平台的bug、己方服务端的bug、H5的bug，都有可能。因此前端也需要根据自己的需要上报日志供查询。

基于以上，初步建立前端异常监控解决方案，包括行为监控、异常监控，主要是：日志采集、存储、分析和报警。
上报的方式分为实时上报和离线上报，上报的数据可分为info，warn，error三种级别，日记级别的数据上报为info类型，可能引发bug的数据上报为warn，捕获到异常的数据上报为error，在数据后台设置阈值，当error某段时间超过阈值时报警。

###实时上报：
1. 封装或重写xhr请求，在参数里增加用户的基础信息，例如经用户授权获取的设备信息等，在后台根据设备系统、系统版本、app版本等可以获得用户群的分布情况，排查异常时也可观察是否属于特定系统、版本类群；
2. 埋点，记录重要流程和用户主要操作，需要规定好上报的命名规范，如：${xx业务}-${页面}-${组件}-${功能}-${操作}，埋点数据可包括用户uid，访问时间，ua等，生成Image对象发送埋点数据请求。相比ajax请求，发送Image请求无需关注请求本身，只用关注发送的数据，服务器不需要返回消息体响应；此外，不受跨域限制。
3. 相对于方式2，在document或者一些标签元素上监听click事件，通过e.target获取点击的dom元素、坐标值，封装数据上报的做法，是对用户所有行为数据进行记录，上报的无效数据可能过多，服务端筛查有效信息变得复杂，根据项目实际情况采用。
4. 项目初始化时对当前代码版本及打包日期的上报，一是排查部分安卓机型缓存未更新，沿用旧代码的错误；二是根据打包日期对照git上打包之前的提交记录，便于锁定相关的修改。
5. 全局异常捕获，window.onerror(参数：message，source，lineno，colno，error)和window.addEventListener('unhandledrejection')，捕获JS异常和Promise抛出的异常。

###离线上报：
增加前端页面访问路径和本地存储数据的日志：
为了避免侵入业务代码中，可采用webworker执行记录、更新、删除等操作；
同时为避免与业务相关本地存储混淆，且不占用localStorage存储区域，日志可存入IndexDB中。每次打开数据库时对超过七天的数据进行删除，并插入最新数据，保持日志记录动态更新。

日志上报的时机可根据项目情况而定，比如检测到脚本错误时上报，比如约定一个上报开关，用户反馈bug后对特定用户开启采集数据。

当前环境下，基本每个页面都不止处理单一渠道单一业务逻辑，其中不乏复用率相当高的页面。
为了展示个性化交互，一般是url参数、路由参数、本地存储（localStorage，sessionStorage）等综合使用的结果。换言之，用户在a页面无法提交数据，还需要根据参数和数据判断该用户处于哪个渠道、哪个业务逻辑分支上。
相比服务端日志，许多页面直接从store中获取数据，或者只依赖于前导页面数据，又或者只是承上启下的纯逻辑承接页，并不需要发出请求，对于前端用户操作回溯并不是完全好用。在没有建立场景回放的项目里，前端访问路径无疑更为直接。
